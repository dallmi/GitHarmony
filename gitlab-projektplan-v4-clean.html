<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab Project Management</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary: #E60000;
            --primary-dark: #B80000;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-tertiary: #F3F4F6;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --border-light: #E5E7EB;
            --border-medium: #D1D5DB;
            --success: #059669;
            --warning: #D97706;
            --danger: #DC2626;
            --info: #2563EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Clean Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-light);
        }

        .nav-tab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        /* Metric Cards */
        .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .metric-card:hover {
            border-color: var(--border-medium);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .metric-value {
            font-size: 36px;
            font-weight: 600;
            line-height: 1;
            margin: 12px 0 8px 0;
        }

        .metric-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-sublabel {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn:hover {
            border-color: var(--border-medium);
            background: var(--bg-tertiary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .badge-success { background: #D1FAE5; color: var(--success); }
        .badge-warning { background: #FEF3C7; color: var(--warning); }
        .badge-danger { background: #FEE2E2; color: var(--danger); }
        .badge-info { background: #DBEAFE; color: var(--info); }

        /* Health Score */
        .health-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 700;
            color: white;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .health-green { background: linear-gradient(135deg, #059669 0%, #10B981 100%); }
        .health-amber { background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%); }
        .health-red { background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Risk Matrix */
        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .risk-cell {
            aspect-ratio: 1;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .risk-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .risk-high {
            background: #FEE2E2;
            border-color: #FCA5A5;
        }
        .risk-medium {
            background: #FEF3C7;
            border-color: #FDE68A;
        }
        .risk-low {
            background: #D1FAE5;
            border-color: #A7F3D0;
        }

        /* Dependency Graph */
        .dependency-graph {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
        }

        .link {
            fill: none;
            stroke: var(--border-medium);
            stroke-width: 2px;
            marker-end: url(#arrowhead);
        }

        .link.blocker {
            stroke: var(--danger);
            stroke-width: 2px;
            stroke-dasharray: 4,4;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        /* Form Elements */
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 0, 0, 0.1);
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        /* Issue Card */
        .issue-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .issue-card:hover {
            border-color: var(--border-medium);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .issue-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .issue-meta {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Typography */
        h1 { font-size: 28px; font-weight: 600; line-height: 1.2; }
        h2 { font-size: 24px; font-weight: 600; line-height: 1.3; }
        h3 { font-size: 18px; font-weight: 600; line-height: 1.4; }
        h4 { font-size: 16px; font-weight: 600; line-height: 1.4; }

        /* Utility Classes */
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        .text-primary { color: var(--primary); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const loadRisks = () => {
            const stored = localStorage.getItem('project_risks');
            return stored ? JSON.parse(stored) : [];
        };

        const saveRisks = (risks) => {
            localStorage.setItem('project_risks', JSON.stringify(risks));
        };

        function GitLabProjectManagement() {
            const [token, setToken] = useState(localStorage.getItem('gitlab_token') || '');
            const [gitlabUrl, setGitlabUrl] = useState(localStorage.getItem('gitlab_url') || 'https://devcloud.ubs.net');
            const [projectId, setProjectId] = useState(localStorage.getItem('gitlab_project') || '');
            const [issues, setIssues] = useState([]);
            const [milestones, setMilestones] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [view, setView] = useState('executive');
            const [selectedMilestone, setSelectedMilestone] = useState('all');
            const [selectedAssignee, setSelectedAssignee] = useState('all');
            const [isConfigured, setIsConfigured] = useState(false);
            const [risks, setRisks] = useState(loadRisks());
            const [showRiskModal, setShowRiskModal] = useState(false);
            const [editingRisk, setEditingRisk] = useState(null);

            useEffect(() => {
                if (token && projectId && gitlabUrl) {
                    setIsConfigured(true);
                    fetchData();
                }
            }, []);

            const saveConfig = () => {
                localStorage.setItem('gitlab_token', token);
                localStorage.setItem('gitlab_url', gitlabUrl);
                localStorage.setItem('gitlab_project', projectId);
                setIsConfigured(true);
                fetchData();
            };

            const fetchData = async () => {
                setLoading(true);
                setError('');
                try {
                    const encodedProjectId = encodeURIComponent(projectId);

                    const issuesResponse = await fetch(
                        `${gitlabUrl}/api/v4/projects/${encodedProjectId}/issues?per_page=200&scope=all`,
                        { headers: { 'PRIVATE-TOKEN': token } }
                    );
                    if (!issuesResponse.ok) throw new Error(`Issues API Error: ${issuesResponse.status}`);
                    const issuesData = await issuesResponse.json();

                    const milestonesResponse = await fetch(
                        `${gitlabUrl}/api/v4/projects/${encodedProjectId}/milestones`,
                        { headers: { 'PRIVATE-TOKEN': token } }
                    );
                    if (!milestonesResponse.ok) throw new Error(`Milestones API Error: ${milestonesResponse.status}`);
                    const milestonesData = await milestonesResponse.json();

                    setIssues(issuesData);
                    setMilestones(milestonesData);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const getSprintFromLabels = (labels) => {
                const sprintLabel = labels.find(l => l.toLowerCase().includes('sprint') || l.toLowerCase().includes('iteration'));
                return sprintLabel || 'Backlog';
            };

            const isBlocker = (labels) => {
                return labels.some(l => l.toLowerCase().includes('blocker') || l.toLowerCase().includes('blocked'));
            };

            const getPriority = (labels) => {
                const labelNames = labels.map(l => l.toLowerCase());
                if (labelNames.some(l => l.includes('critical') || l.includes('urgent') || l.includes('high'))) return 'high';
                if (labelNames.some(l => l.includes('low'))) return 'low';
                return 'medium';
            };

            const getProgress = (issue) => {
                if (issue.state === 'closed') return 100;
                const labelNames = issue.labels.map(l => l.toLowerCase());
                if (labelNames.some(l => l.includes('review') || l.includes('testing'))) return 75;
                if (labelNames.some(l => l.includes('progress') || l.includes('wip'))) return 50;
                if (labelNames.some(l => l.includes('started'))) return 25;
                return 0;
            };

            const extractDependencies = (issue) => {
                const deps = [];
                const description = issue.description || '';
                const blockedByPattern = /(?:blocked by|depends on|requires)\s*#(\d+)/gi;
                let match;
                while ((match = blockedByPattern.exec(description)) !== null) {
                    deps.push(parseInt(match[1]));
                }
                return deps;
            };

            const uniqueAssignees = useMemo(() => {
                const assigneeMap = new Map();
                issues.forEach(issue => {
                    issue.assignees?.forEach(a => {
                        assigneeMap.set(a.id, a);
                    });
                });
                return Array.from(assigneeMap.values());
            }, [issues]);

            const filteredIssues = useMemo(() => {
                return issues.filter(issue => {
                    if (selectedMilestone !== 'all' && issue.milestone?.id !== parseInt(selectedMilestone)) return false;
                    if (selectedAssignee !== 'all' && !issue.assignees?.some(a => a.id === parseInt(selectedAssignee))) return false;
                    return true;
                });
            }, [issues, selectedMilestone, selectedAssignee]);

            const stats = useMemo(() => {
                const total = filteredIssues.length;
                const open = filteredIssues.filter(i => i.state === 'opened').length;
                const closed = filteredIssues.filter(i => i.state === 'closed').length;
                const blockers = filteredIssues.filter(i => isBlocker(i.labels)).length;
                const overdue = filteredIssues.filter(i => i.due_date && new Date(i.due_date) < new Date() && i.state === 'opened').length;
                const atRisk = filteredIssues.filter(i => {
                    if (!i.due_date || i.state === 'closed') return false;
                    const daysUntilDue = Math.floor((new Date(i.due_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysUntilDue <= 7 && daysUntilDue >= 0;
                }).length;
                const completionRate = total > 0 ? Math.round((closed / total) * 100) : 0;
                return { total, open, closed, blockers, overdue, atRisk, completionRate };
            }, [filteredIssues]);

            const healthScore = useMemo(() => {
                const weights = { completion: 0.3, schedule: 0.25, blockers: 0.25, risk: 0.2 };
                const completionScore = stats.completionRate;
                const scheduleScore = stats.total > 0 ? Math.max(0, 100 - (stats.overdue / stats.total * 200)) : 100;
                const blockerScore = stats.total > 0 ? Math.max(0, 100 - (stats.blockers / stats.total * 300)) : 100;
                const riskScore = stats.total > 0 ? Math.max(0, 100 - (stats.atRisk / stats.total * 200)) : 100;

                const overall = Math.round(
                    completionScore * weights.completion +
                    scheduleScore * weights.schedule +
                    blockerScore * weights.blockers +
                    riskScore * weights.risk
                );

                let status = 'red';
                if (overall >= 75) status = 'green';
                else if (overall >= 50) status = 'amber';

                return { score: overall, status, breakdown: { completionScore, scheduleScore, blockerScore, riskScore } };
            }, [stats]);

            const dependencyData = useMemo(() => {
                const nodes = filteredIssues.map(issue => ({
                    id: issue.iid,
                    title: issue.title,
                    state: issue.state,
                    isBlocker: isBlocker(issue.labels),
                    assignee: issue.assignees?.[0]?.name || 'Unassigned'
                }));

                const links = [];
                filteredIssues.forEach(issue => {
                    const deps = extractDependencies(issue);
                    deps.forEach(depIid => {
                        if (filteredIssues.find(i => i.iid === depIid)) {
                            links.push({
                                source: depIid,
                                target: issue.iid,
                                isBlocker: isBlocker(issue.labels)
                            });
                        }
                    });
                });

                return { nodes, links };
            }, [filteredIssues]);

            const addRisk = (riskData) => {
                const newRisk = {
                    id: Date.now(),
                    ...riskData,
                    createdAt: new Date().toISOString(),
                    mitigations: []
                };
                const updated = [...risks, newRisk];
                setRisks(updated);
                saveRisks(updated);
            };

            const updateRisk = (id, updates) => {
                const updated = risks.map(r => r.id === id ? { ...r, ...updates } : r);
                setRisks(updated);
                saveRisks(updated);
            };

            const deleteRisk = (id) => {
                const updated = risks.filter(r => r.id !== id);
                setRisks(updated);
                saveRisks(updated);
            };

            const addMitigation = (riskId, mitigation) => {
                const updated = risks.map(r => {
                    if (r.id === riskId) {
                        return {
                            ...r,
                            mitigations: [...(r.mitigations || []), {
                                id: Date.now(),
                                ...mitigation,
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            }]
                        };
                    }
                    return r;
                });
                setRisks(updated);
                saveRisks(updated);
            };

            const updateMitigation = (riskId, mitigationId, status) => {
                const updated = risks.map(r => {
                    if (r.id === riskId) {
                        return {
                            ...r,
                            mitigations: r.mitigations.map(m =>
                                m.id === mitigationId ? { ...m, status } : m
                            )
                        };
                    }
                    return r;
                });
                setRisks(updated);
                saveRisks(updated);
            };

            const exportToPowerPoint = () => {
                const pptx = new PptxGenJS();
                pptx.author = 'GitLab Project Management';
                pptx.company = 'UBS';
                pptx.title = `Project Status - ${projectId}`;

                const slide1 = pptx.addSlide();
                slide1.background = { color: 'FFFFFF' };

                slide1.addText('Executive Summary', {
                    x: 0.5, y: 0.5, w: 9, h: 0.7,
                    fontSize: 32, bold: true, color: 'E60000'
                });

                slide1.addText(projectId, {
                    x: 0.5, y: 1.2, w: 9, h: 0.4,
                    fontSize: 18, color: '666666'
                });

                const healthColor = healthScore.status === 'green' ? '059669' :
                                   healthScore.status === 'amber' ? 'D97706' : 'DC2626';

                slide1.addText(`Project Health: ${healthScore.score}%`, {
                    x: 0.5, y: 2.3, w: 4, h: 1,
                    fontSize: 28, bold: true, color: healthColor
                });

                const metricsData = [
                    ['Metric', 'Value'],
                    ['Total Issues', stats.total.toString()],
                    ['Completion Rate', `${stats.completionRate}%`],
                    ['Blockers', stats.blockers.toString()],
                    ['Active Risks', risks.filter(r => r.status === 'active').length.toString()]
                ];

                slide1.addTable(metricsData, {
                    x: 5.0, y: 2.3, w: 4.5, h: 3,
                    fontSize: 14,
                    color: '333333',
                    fill: { color: 'F8F9FA' }
                });

                pptx.writeFile({ fileName: `Project-Status-${projectId.replace('/', '-')}-${new Date().toISOString().split('T')[0]}.pptx` });
            };

            const RiskModal = ({ risk, onClose, onSave }) => {
                const [formData, setFormData] = useState(risk || {
                    title: '',
                    description: '',
                    probability: 'medium',
                    impact: 'medium',
                    status: 'active',
                    owner: ''
                });

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                            <h2 style={{ marginBottom: '24px' }}>{risk ? 'Edit Risk' : 'Add New Risk'}</h2>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                                <div>
                                    <label>Title</label>
                                    <input
                                        type="text"
                                        value={formData.title}
                                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label>Description</label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        rows="3"
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label>Probability</label>
                                        <select
                                            value={formData.probability}
                                            onChange={(e) => setFormData({...formData, probability: e.target.value})}
                                        >
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>Impact</label>
                                        <select
                                            value={formData.impact}
                                            onChange={(e) => setFormData({...formData, impact: e.target.value})}
                                        >
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label>Owner</label>
                                    <input
                                        type="text"
                                        value={formData.owner}
                                        onChange={(e) => setFormData({...formData, owner: e.target.value})}
                                    />
                                </div>
                                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '8px' }}>
                                    <button onClick={onClose} className="btn">Cancel</button>
                                    <button
                                        onClick={() => {
                                            onSave(formData);
                                            onClose();
                                        }}
                                        className="btn btn-primary"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DependencyGraphView = () => {
                const svgRef = useRef(null);

                useEffect(() => {
                    if (!svgRef.current || dependencyData.nodes.length === 0) return;

                    const width = svgRef.current.clientWidth;
                    const height = 600;

                    d3.select(svgRef.current).selectAll("*").remove();

                    const svg = d3.select(svgRef.current)
                        .attr('width', width)
                        .attr('height', height);

                    svg.append('defs').append('marker')
                        .attr('id', 'arrowhead')
                        .attr('viewBox', '-0 -5 10 10')
                        .attr('refX', 25)
                        .attr('refY', 0)
                        .attr('orient', 'auto')
                        .attr('markerWidth', 6)
                        .attr('markerHeight', 6)
                        .append('svg:path')
                        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                        .attr('fill', '#9CA3AF');

                    const simulation = d3.forceSimulation(dependencyData.nodes)
                        .force('link', d3.forceLink(dependencyData.links).id(d => d.id).distance(150))
                        .force('charge', d3.forceManyBody().strength(-400))
                        .force('center', d3.forceCenter(width / 2, height / 2))
                        .force('collision', d3.forceCollide().radius(40));

                    const link = svg.append('g')
                        .selectAll('path')
                        .data(dependencyData.links)
                        .enter()
                        .append('path')
                        .attr('class', d => `link ${d.isBlocker ? 'blocker' : ''}`);

                    const node = svg.append('g')
                        .selectAll('g')
                        .data(dependencyData.nodes)
                        .enter()
                        .append('g')
                        .attr('class', 'node')
                        .call(d3.drag()
                            .on('start', dragstarted)
                            .on('drag', dragged)
                            .on('end', dragended));

                    node.append('circle')
                        .attr('r', 20)
                        .attr('fill', d => {
                            if (d.isBlocker) return '#DC2626';
                            if (d.state === 'closed') return '#059669';
                            return '#2563EB';
                        });

                    node.append('text')
                        .attr('dy', -25)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '12px')
                        .attr('font-weight', '500')
                        .attr('fill', '#1F2937')
                        .text(d => `#${d.id}`);

                    node.append('title')
                        .text(d => `#${d.id}: ${d.title}\n${d.assignee}`);

                    simulation.on('tick', () => {
                        link.attr('d', d => {
                            const dx = d.target.x - d.source.x;
                            const dy = d.target.y - d.source.y;
                            const dr = Math.sqrt(dx * dx + dy * dy);
                            return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                        });

                        node.attr('transform', d => `translate(${d.x},${d.y})`);
                    });

                    function dragstarted(event, d) {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    }

                    function dragged(event, d) {
                        d.fx = event.x;
                        d.fy = event.y;
                    }

                    function dragended(event, d) {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    }

                }, [dependencyData]);

                if (dependencyData.nodes.length === 0) {
                    return (
                        <div className="card" style={{ textAlign: 'center', padding: '80px 40px' }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.3 }}>○ ― ○</div>
                            <h3 style={{ marginBottom: '8px', color: 'var(--text-secondary)' }}>No Dependencies Found</h3>
                            <p style={{ color: 'var(--text-tertiary)', fontSize: '14px' }}>
                                Add "blocked by #123" or "depends on #123" to issue descriptions.
                            </p>
                        </div>
                    );
                }

                return (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                        <div className="card">
                            <h3 style={{ marginBottom: '20px' }}>Dependency Graph</h3>
                            <div style={{ display: 'flex', gap: '24px', marginBottom: '24px', fontSize: '13px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '16px', height: '16px', borderRadius: '50%', background: '#2563EB' }}></div>
                                    <span style={{ color: 'var(--text-secondary)' }}>In Progress</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '16px', height: '16px', borderRadius: '50%', background: '#059669' }}></div>
                                    <span style={{ color: 'var(--text-secondary)' }}>Completed</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '16px', height: '16px', borderRadius: '50%', background: '#DC2626' }}></div>
                                    <span style={{ color: 'var(--text-secondary)' }}>Blocker</span>
                                </div>
                            </div>
                            <svg ref={svgRef} className="dependency-graph" style={{ width: '100%' }}></svg>
                        </div>

                        <div className="card">
                            <h4 style={{ marginBottom: '16px' }}>Statistics</h4>
                            <div className="stats-grid">
                                <div className="stat-item">
                                    <div className="stat-value">{dependencyData.nodes.length}</div>
                                    <div className="stat-label">Total Issues</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value">{dependencyData.links.length}</div>
                                    <div className="stat-label">Dependencies</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value text-danger">{dependencyData.links.filter(l => l.isBlocker).length}</div>
                                    <div className="stat-label">Blocking</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const RiskRegisterView = () => {
                const riskMatrix = {
                    'high-high': risks.filter(r => r.probability === 'high' && r.impact === 'high' && r.status === 'active'),
                    'high-medium': risks.filter(r => r.probability === 'high' && r.impact === 'medium' && r.status === 'active'),
                    'high-low': risks.filter(r => r.probability === 'high' && r.impact === 'low' && r.status === 'active'),
                    'medium-high': risks.filter(r => r.probability === 'medium' && r.impact === 'high' && r.status === 'active'),
                    'medium-medium': risks.filter(r => r.probability === 'medium' && r.impact === 'medium' && r.status === 'active'),
                    'medium-low': risks.filter(r => r.probability === 'medium' && r.impact === 'low' && r.status === 'active'),
                    'low-high': risks.filter(r => r.probability === 'low' && r.impact === 'high' && r.status === 'active'),
                    'low-medium': risks.filter(r => r.probability === 'low' && r.impact === 'medium' && r.status === 'active'),
                    'low-low': risks.filter(r => r.probability === 'low' && r.impact === 'low' && r.status === 'active'),
                };

                const getRiskClass = (prob, impact) => {
                    if ((prob === 'high' && impact === 'high') ||
                        (prob === 'high' && impact === 'medium') ||
                        (prob === 'medium' && impact === 'high')) return 'risk-high';
                    if ((prob === 'medium' && impact === 'medium') ||
                        (prob === 'low' && impact === 'high') ||
                        (prob === 'high' && impact === 'low')) return 'risk-medium';
                    return 'risk-low';
                };

                return (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                        <div className="card">
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '32px' }}>
                                <h2>Risk Register</h2>
                                <button onClick={() => setShowRiskModal(true)} className="btn btn-primary">
                                    Add Risk
                                </button>
                            </div>

                            <h4 style={{ marginBottom: '16px', fontWeight: 500 }}>Probability × Impact Matrix</h4>
                            <div className="risk-matrix">
                                <div></div>
                                <div style={{ textAlign: 'center', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)' }}>Low Impact</div>
                                <div style={{ textAlign: 'center', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)' }}>Medium Impact</div>
                                <div style={{ textAlign: 'center', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)' }}>High Impact</div>

                                <div style={{ textAlign: 'right', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)', paddingRight: '12px', display: 'flex', alignItems: 'center', justifyContent: 'flex-end' }}>High Prob</div>
                                <div className={`risk-cell ${getRiskClass('high', 'low')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['high-low'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('high', 'medium')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['high-medium'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('high', 'high')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['high-high'].length}</span>
                                </div>

                                <div style={{ textAlign: 'right', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)', paddingRight: '12px', display: 'flex', alignItems: 'center', justifyContent: 'flex-end' }}>Med Prob</div>
                                <div className={`risk-cell ${getRiskClass('medium', 'low')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['medium-low'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('medium', 'medium')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['medium-medium'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('medium', 'high')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['medium-high'].length}</span>
                                </div>

                                <div style={{ textAlign: 'right', fontSize: '12px', fontWeight: 500, color: 'var(--text-secondary)', paddingRight: '12px', display: 'flex', alignItems: 'center', justifyContent: 'flex-end' }}>Low Prob</div>
                                <div className={`risk-cell ${getRiskClass('low', 'low')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['low-low'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('low', 'medium')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['low-medium'].length}</span>
                                </div>
                                <div className={`risk-cell ${getRiskClass('low', 'high')}`}>
                                    <span style={{ fontSize: '24px', fontWeight: 600 }}>{riskMatrix['low-high'].length}</span>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h4 style={{ marginBottom: '20px' }}>Active Risks</h4>
                            {risks.filter(r => r.status === 'active').length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--text-tertiary)' }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.3 }}>○</div>
                                    <div>No active risks. Click "Add Risk" to create one.</div>
                                </div>
                            ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                    {risks.filter(r => r.status === 'active').map(risk => (
                                        <div key={risk.id} style={{ padding: '20px', border: '1px solid var(--border-light)', borderRadius: '8px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div style={{ flex: 1 }}>
                                                    <h4 style={{ marginBottom: '8px' }}>{risk.title}</h4>
                                                    <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px' }}>{risk.description}</p>
                                                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                                        <span className={`badge ${
                                                            risk.probability === 'high' ? 'badge-danger' :
                                                            risk.probability === 'medium' ? 'badge-warning' : 'badge-success'
                                                        }`}>
                                                            Probability: {risk.probability}
                                                        </span>
                                                        <span className={`badge ${
                                                            risk.impact === 'high' ? 'badge-danger' :
                                                            risk.impact === 'medium' ? 'badge-warning' : 'badge-success'
                                                        }`}>
                                                            Impact: {risk.impact}
                                                        </span>
                                                        {risk.owner && (
                                                            <span className="badge">Owner: {risk.owner}</span>
                                                        )}
                                                    </div>

                                                    {risk.mitigations && risk.mitigations.length > 0 && (
                                                        <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--border-light)' }}>
                                                            <div style={{ fontSize: '13px', fontWeight: 500, marginBottom: '8px' }}>Mitigation Actions:</div>
                                                            {risk.mitigations.map(m => (
                                                                <div key={m.id} style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px', marginLeft: '4px', marginTop: '6px' }}>
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={m.status === 'completed'}
                                                                        onChange={() => updateMitigation(
                                                                            risk.id,
                                                                            m.id,
                                                                            m.status === 'completed' ? 'pending' : 'completed'
                                                                        )}
                                                                        style={{ cursor: 'pointer' }}
                                                                    />
                                                                    <span style={{ color: m.status === 'completed' ? 'var(--text-tertiary)' : 'var(--text-primary)', textDecoration: m.status === 'completed' ? 'line-through' : 'none' }}>
                                                                        {m.action} {m.owner && `(${m.owner})`}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                <div style={{ display: 'flex', gap: '8px', marginLeft: '16px' }}>
                                                    <button
                                                        onClick={() => {
                                                            const action = prompt('Enter mitigation action:');
                                                            const owner = prompt('Owner (optional):');
                                                            if (action) addMitigation(risk.id, { action, owner });
                                                        }}
                                                        className="btn"
                                                        style={{ fontSize: '13px', padding: '6px 12px' }}
                                                    >
                                                        Add Action
                                                    </button>
                                                    <button
                                                        onClick={() => updateRisk(risk.id, { status: 'closed' })}
                                                        className="btn"
                                                        style={{ fontSize: '13px', padding: '6px 12px' }}
                                                    >
                                                        Close
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {showRiskModal && (
                            <RiskModal
                                risk={editingRisk}
                                onClose={() => {
                                    setShowRiskModal(false);
                                    setEditingRisk(null);
                                }}
                                onSave={(data) => {
                                    if (editingRisk) {
                                        updateRisk(editingRisk.id, data);
                                    } else {
                                        addRisk(data);
                                    }
                                }}
                            />
                        )}
                    </div>
                );
            };

            const ExecutiveDashboard = () => {
                const activeRisks = risks.filter(r => r.status === 'active').length;
                const highRisks = risks.filter(r => r.status === 'active' && r.probability === 'high' && r.impact === 'high').length;
                const topBlockers = filteredIssues.filter(i => isBlocker(i.labels) && i.state === 'opened').slice(0, 3);
                const recentlyCompleted = filteredIssues.filter(i => i.state === 'closed')
                    .sort((a, b) => new Date(b.closed_at || 0) - new Date(a.closed_at || 0)).slice(0, 3);

                return (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                        <div className="card">
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <div style={{ flex: 1 }}>
                                    <h1 style={{ marginBottom: '8px' }}>Project Health</h1>
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '15px' }}>Overall project performance and key metrics</p>
                                </div>
                                <div className={`health-circle health-${healthScore.status}`}>
                                    {healthScore.score}
                                </div>
                            </div>

                            <div className="stats-grid" style={{ marginTop: '32px' }}>
                                <div className="stat-item">
                                    <div className="stat-label">COMPLETION</div>
                                    <div className="stat-value">{Math.round(healthScore.breakdown.completionScore)}%</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-label">SCHEDULE</div>
                                    <div className="stat-value">{Math.round(healthScore.breakdown.scheduleScore)}%</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-label">BLOCKERS</div>
                                    <div className="stat-value">{Math.round(healthScore.breakdown.blockerScore)}%</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-label">RISK</div>
                                    <div className="stat-value">{Math.round(healthScore.breakdown.riskScore)}%</div>
                                </div>
                            </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '20px' }}>
                            <div className="metric-card">
                                <div className="metric-label">Completion Rate</div>
                                <div className="metric-value text-primary">{stats.completionRate}%</div>
                                <div className="metric-sublabel">{stats.closed} of {stats.total} issues</div>
                                <div className="progress-bar" style={{ marginTop: '12px' }}>
                                    <div className="progress-fill" style={{ width: `${stats.completionRate}%` }}></div>
                                </div>
                            </div>

                            <div className="metric-card">
                                <div className="metric-label">Blockers</div>
                                <div className="metric-value text-danger">{stats.blockers}</div>
                                <div className="metric-sublabel">Requiring attention</div>
                            </div>

                            <div className="metric-card">
                                <div className="metric-label">Active Risks</div>
                                <div className="metric-value text-warning">{activeRisks}</div>
                                <div className="metric-sublabel">{highRisks} high priority</div>
                            </div>

                            <div className="metric-card">
                                <div className="metric-label">Dependencies</div>
                                <div className="metric-value text-info">{dependencyData.links.length}</div>
                                <div className="metric-sublabel">Issue dependencies</div>
                            </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                            <div className="card">
                                <h3 style={{ marginBottom: '16px' }}>Critical Blockers</h3>
                                {topBlockers.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {topBlockers.map(issue => (
                                            <div key={issue.id} className="issue-card"
                                                 style={{ borderLeft: '3px solid var(--danger)' }}
                                                 onClick={() => window.open(issue.web_url, '_blank')}>
                                                <div className="issue-title">#{issue.iid} {issue.title}</div>
                                                <div className="issue-meta">{issue.assignees?.[0]?.name || 'Unassigned'}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-tertiary)' }}>
                                        <div style={{ fontSize: '32px', marginBottom: '8px', opacity: 0.3 }}>✓</div>
                                        <div style={{ fontSize: '14px' }}>No critical blockers</div>
                                    </div>
                                )}
                            </div>

                            <div className="card">
                                <h3 style={{ marginBottom: '16px' }}>Recent Achievements</h3>
                                {recentlyCompleted.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {recentlyCompleted.map(issue => (
                                            <div key={issue.id} className="issue-card"
                                                 style={{ borderLeft: '3px solid var(--success)' }}
                                                 onClick={() => window.open(issue.web_url, '_blank')}>
                                                <div className="issue-title">#{issue.iid} {issue.title}</div>
                                                <div className="issue-meta">By {issue.assignees?.[0]?.name || 'Unknown'}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-tertiary)' }}>
                                        <div style={{ fontSize: '32px', marginBottom: '8px', opacity: 0.3 }}>○</div>
                                        <div style={{ fontSize: '14px' }}>No completed issues yet</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            if (!isConfigured) {
                return (
                    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
                        <div className="card" style={{ maxWidth: '500px', width: '100%' }}>
                            <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                                <h1 style={{ marginBottom: '8px' }}>GitLab PM Dashboard</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Enterprise Edition</p>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                                <div>
                                    <label>GitLab URL</label>
                                    <input
                                        type="text"
                                        value={gitlabUrl}
                                        onChange={(e) => setGitlabUrl(e.target.value)}
                                        placeholder="https://devcloud.ubs.net"
                                    />
                                </div>
                                <div>
                                    <label>Personal Access Token</label>
                                    <input
                                        type="password"
                                        value={token}
                                        onChange={(e) => setToken(e.target.value)}
                                        placeholder="glpat-..."
                                    />
                                </div>
                                <div>
                                    <label>Project ID</label>
                                    <input
                                        type="text"
                                        value={projectId}
                                        onChange={(e) => setProjectId(e.target.value)}
                                        placeholder="namespace/project"
                                    />
                                </div>
                                <button
                                    onClick={saveConfig}
                                    disabled={!token || !projectId || !gitlabUrl}
                                    className="btn btn-primary"
                                    style={{ marginTop: '8px' }}
                                >
                                    Connect
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ minHeight: '100vh' }}>
                    <div className="header">
                        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '20px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '20px' }}>
                                <div>
                                    <h2 style={{ marginBottom: '4px' }}>Project Dashboard</h2>
                                    <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>{projectId}</p>
                                </div>
                                <div style={{ display: 'flex', gap: '12px' }}>
                                    <button onClick={exportToPowerPoint} className="btn">
                                        Export Report
                                    </button>
                                    <button onClick={fetchData} disabled={loading} className="btn">
                                        {loading ? 'Loading...' : 'Refresh'}
                                    </button>
                                </div>
                            </div>

                            <div className="stats-grid">
                                <div className="stat-item">
                                    <div className="stat-value">{stats.total}</div>
                                    <div className="stat-label">TOTAL</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value">{stats.completionRate}%</div>
                                    <div className="stat-label">COMPLETE</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value text-danger">{stats.blockers}</div>
                                    <div className="stat-label">BLOCKERS</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value text-warning">{stats.atRisk}</div>
                                    <div className="stat-label">AT RISK</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value text-warning">{risks.filter(r => r.status === 'active').length}</div>
                                    <div className="stat-label">RISKS</div>
                                </div>
                                <div className="stat-item">
                                    <div className="stat-value text-info">{dependencyData.links.length}</div>
                                    <div className="stat-label">DEPENDENCIES</div>
                                </div>
                            </div>

                            <div className="nav-tabs" style={{ marginTop: '20px' }}>
                                <button
                                    onClick={() => setView('executive')}
                                    className={`nav-tab ${view === 'executive' ? 'active' : ''}`}>
                                    Executive
                                </button>
                                <button
                                    onClick={() => setView('dependencies')}
                                    className={`nav-tab ${view === 'dependencies' ? 'active' : ''}`}>
                                    Dependencies
                                </button>
                                <button
                                    onClick={() => setView('risks')}
                                    className={`nav-tab ${view === 'risks' ? 'active' : ''}`}>
                                    Risks
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px 20px' }}>
                        {error && (
                            <div style={{ background: '#FEE2E2', border: '1px solid #FCA5A5', borderRadius: '8px', padding: '16px', marginBottom: '24px' }}>
                                <div style={{ fontWeight: 500, color: '#991B1B', marginBottom: '4px' }}>Error</div>
                                <div style={{ fontSize: '14px', color: '#7F1D1D' }}>{error}</div>
                            </div>
                        )}

                        {loading ? (
                            <div style={{ textAlign: 'center', padding: '100px 20px' }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.3 }}>○</div>
                                <div style={{ fontSize: '16px', color: 'var(--text-secondary)' }}>Loading data...</div>
                            </div>
                        ) : (
                            <>
                                {view === 'executive' && <ExecutiveDashboard />}
                                {view === 'dependencies' && <DependencyGraphView />}
                                {view === 'risks' && <RiskRegisterView />}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GitLabProjectManagement />, document.getElementById('root'));
    </script>
</body>
</html>
